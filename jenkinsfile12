pipeline {
    agent {
       label {label 'jdk17'}
}
    stages {
        stage('clone code base') {
            steps {
                echo 'cloning from github'
                git (url:'https://github.com/MelGhiz/maven-project.git',
                branch:'master', credentialsId:'cred4github')
               
            }
        }
        stage('compile & testing'){
            steps {
                echo 'compiling & unit testing'
                withMaven(maven: 'localMAVEN'){
                    sh 'mvn clean test'
                }
            }
        
        }
            stage('build'){
            steps {
                echo 'create package app'
                 withMaven(maven: 'localMAVEN'){
                    sh 'mvn clean -B -DSkipTests package'
                }
            
            }
            }
               stage('Code Source Qualimetry Analysis') {
            steps {
                echo 'Code Source Qualimetry Analysis wirh Warnings & Co.'
                //lancer l'analyse de Warnings via Maven
                sh 'mvn checkstyle:checkstyle'
                //Générer le rapport de couverture avec Cobertura
                sh 'mvn cobertura:cobertura'
            }
            post {
                always {
                    //Publier les rapports de couverture
                    cobertura autoUpdateHealth: false, autoUpdateStability: false, 
                    coberturaReportFile: 'target/site/cobertura/coverage.xml', failNoReports: false, 
                    maxNumberOfBuilds: 0, sourceEncoding: 'UTF_8', zoomCoverageChart: false
                    
                    //Publier le rapport Warnings
                    recordIssues tools: [checkStyle(pattern: 'target/checkstyle-result.xml')], 
                    enabledForFailure: true
                }
            }
        }
                
              stage('archive & Deploy') {
            steps{
                echo 'atchiving on nexus /artifact/.M2'
                 withMaven(maven: 'localMAVEN'){
                    sh 'mvn clean -B -DSkipTests package'
                }
            
            }
        }
    }
}
